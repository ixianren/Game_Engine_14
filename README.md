# Game_Engine_14
工程文件与可执行文件均在master branch中，其中可执行文件在built文件夹里

游戏使用了1000个粒子模拟水流，来和场景中的其它物体交互组成核心玩法，导致极大的CPU开销，在未优化时，即便运行在3.6GHz处理器的台式电脑上，帧率也无法流畅游戏

经过Deep Profiling排查主要发现了四个程序算法上的极大性能开销，后进行了优化

1.水珠灭失后，流体解算器重新计算其余水珠的位置前需要遍历整个列表，当水珠快速流失和再生时，这一逐帧遍历计算成本过高，因此采用了两个方法相配合，首先是每次灭失一个水珠时，将灭失的水珠与列表中最后一个活着的水珠位置交换，使得列表始终保持前一部分的水珠全部为活跃水珠，后一部分水珠全部为不活跃水珠，这样交换后记录最后一个活跃水珠的位置即可每次重新计算时，只需将最后一个活跃水珠之前的全部水珠加入解算器即可，省去平均一半的开销；其次是减少每帧灭失水珠的个数，当一帧需要灭失超过3个水珠时，将多余水珠移到后续帧进行灭失，保持每帧仅最多灭失三个水珠，由于设定中需要100个水珠浇灌成长一株植物，因此在帧率大于30FPS时，这种后移并不影响体验

2.植物成长需要n个（游戏中设定为100）不同水珠碰撞，如果每次通过遍历列表来判断新碰撞是否来自新水珠会有极大性能开销，因此利用了哈希表的判断，利用int型哈希表，当有水珠碰撞时，通过计算该水珠序号的哈希值，如果值未出现在哈希表中则入表，反之则该水珠已经碰过该植物，跳过，由于哈希表的判断是O（1），因此节省了时间开销，同时由于是整型哈希表且水珠数为1000，哈希表所占内存较小，十分划算。

3.游戏中的镜头跟随与水流自动聚敛，用到了重心的计算，初始未优化时，重心采用每帧遍历列表重新计算得到，造成重复计算，性能浪费，新的重心计算方法改用一个长度为n的动态列表计算，当列表增加一个新(x,y,z,w)位置时，列表的原重心乘以n加上新位置再除以n+1即可，当列表减少一个位置时，列表的原重心乘以n减去减少位置再除以n-1，即用增量的方法计算改变的重心而非重新计算

4.流体解算器的碰撞极为消耗性能，由于需要每帧计算每个粒子与所有碰撞体包括粒子之间的碰撞，当粒子数较多，此处为1000时，占用大量CPU计算资源，因此考虑合并碰撞，将能够一起检测的碰撞打成一个组

